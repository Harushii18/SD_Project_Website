
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>

<!-- Div to display alerts when studnets are assigned -->
<div id="showAssign" class="alert alert-primary" role="alert">

</div>

<div style="text-align:center; position:absolute;">
<br></br>
<h1>Manage Schedules</h1>

<br>

<!-- Vertically centered modal -->
<div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">SELECT HOSPITAL</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <em>Assign Student To A Hospital Below:</em>

        <br>
        <br>

        <!--Dropdown for hospitals -->
        <select name="hospital_drop" id="hospital_id"  class="btn btn-secondary dropdown-toggle">
        <%= options = options_from_collection_for_select(Hospital.all, 'id', 'hospital_name') %>
        </select>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="assignHospital()" data-dismiss="modal">Confirm</button>
      </div>
    </div>
  </div>
</div>


<br>

<div class="container-fluid">
    <div class="d-flex justify-content-evenly">

    </div>
</div>

<!-- Add search forms for OWN model -->
<!-- unless statement takes out search bar when editing,creating,etc-->
<% unless url_for != users_path %>
<!--Makes the seach field neater however cant find a way to pull search field to  right of navbar -->
  <form class="form-inline my-2 my-lg-0">
      <%=render "users/filters"%>
  </form>
<% end %>
<!--ADD Below check users controller and -filters.html.erb for eg -->




<form action="/schedules">
<label> <h5>Select Programme Code</h5> </label>
<br>
<select name="programme_id" id="programme_id" onchange="this.form.submit()" class="btn btn-primary dropdown-toggle">
<%= options = options_from_collection_for_select(Programme.all, 'id', 'programme_code',@current_programme_id) %>
</select>
</form>
<br></br>
<button type="button" class="btn btn-primary" onclick="makeChanges()">Make Changes</button>
<!-- Some functions for the Drag and Drop Feature -->


<div class="m-4" id="schedule_window">


<script>

/*Note: Here is a rough hierarchical structure of the classes:

(-->: uses)

ProgrammeSchedule-->Timeline
Timeline-->TimeBlock
Timeline-->SpecialtyBlock
Timeline-->Schedule

*/


  class Timeline{
    constructor(studentID, studentName, studentNumber){
        this.studentID = studentID;
        this.studentName = studentName;
        this.studentNumber = studentNumber;
        this.specialties = [];
        this.hospitals = [];
        this.timeBlocks = [];
        this.schedules = [];
        this.initialiseTimeBlocks(studentID);
        this.initialiseSpecialties();
        this.initialiseSchedules();
        //console.log("There are this many timeblocks: "+this.timeBlocks.length);

        //This button acts as an event so that the array of schedules can be poppulated
        this.btnSaveToChanges = document.createElement('button');
        this.btnSaveToChanges.innerHTML = "Save to changes";
        this.btnSaveToChanges.setAttribute("class","btn btn-outline-success");

        //When Save to Changes is clicked, populate schedules with all current schedules in timeline - checks each timebox.
        var that = this;
        this.btnSaveToChanges.onclick = function(ev){
          this.schedules = [];
          console.log("StudentID is: " + that.studentID);
          for(var i=0; i<52;i++){
            if(that.timeBlocks[i].getAssigned()==true){
              console.log("Create a new schedule in the timeline");
              var newSchedule = new Schedule();
              newSchedule.setWeekNo(that.timeBlocks[i].getWeekNo());
              newSchedule.setSpecialtyID(that.timeBlocks[i].getSpecialtyID());
              newSchedule.setStudentID(that.studentID);
              newSchedule.setSpecialtyDuration(that.timeBlocks[i].getSpecialtyDuration());
              console.log("save clicked, hospitalID is : " +that.timeBlocks[i].hospitalID)
              //TODO: Set Hospital ID

              console.log("timeline constructor")
              console.log(that.timeBlocks[i].getSpecialtyID());
              console.log("timeline constructor")
           

              that.schedules.push(newSchedule);
            }

          }
        };


    }

    initialiseTimeBlocks(studentID){
      for(var i =0; i<52; i++){
        var timeBlock = new TimeBlock(i+1, studentID);
        
       this.timeBlocks.push(timeBlock);
      }
    }

    //TODO: Fetch Specialty Name and Duration
    initialiseSpecialties(){
      <% @specialties.each do |specialty| %>
        var specialtyBlock = new SpecialtyBlock(<%= specialty.id %>, <%= specialty.id %>, 2, this.studentID);
        this.specialties.push(specialtyBlock);
      <%end%>
    }

    //TODO: Populate schedule array with any existing schedules, for that student, found in the database.
    initialiseSchedules(){

    }

    //Remove Schedule for a weekNo
    removeSchedule(weekNo){
      for(var i = 0; i< this.schedules.length; i++){
        if(this.schedules[i].getWeekNo()==weekNo){
          this.schedules.splice(i,1);
        }
      }
    }

    //Return array of schedules
    getSchedules(){
      return this.schedules;
    }

    displayTimeline(){

      //Main Table
      var table = document.createElement('table');
      table.setAttribute("border","border:1px solid gray");

      //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<Spacing>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
      var br = document.createElement('br');
      table.appendChild(br);
      //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<Spacing>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

      //Add student information
      var studentInformation = [this.studentNumber, this.studentName];
      for(var i = 0 ;i<studentInformation.length;i++){
        var tr = document.createElement('tr');
        var p = document.createElement('p');
        p.innerHTML = studentInformation[i];
        //console.log("Student Info: " + p.innerHTML);
        var td = document.createElement('td');
        //td.style.align="left";
        td.appendChild(p);
        tr.appendChild(td);
        table.appendChild(tr);
      }

      //Add Specialties for students
      //console.log("Length of specialties is: "  + this.specialties.length);
      for(var i = 0; i<this.specialties.length;i++ ){
        //console.log("Added this specialty: "+i);
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.appendChild(this.specialties[i].getDiv());
        tr.appendChild(td);
        table.appendChild(tr);
      }



      //Visual timeline
      //52 divs - Timeblocks
      var tr = document.createElement('tr');
      for(var i = 0; i<52; i++){
        var p = document.createElement('p');
        //p.innerHTML = studentInformation[i];
        var td = document.createElement('td');
        td.appendChild(this.timeBlocks[i].getDiv());
        tr.appendChild(td);
      }

      //Container for 52 Timeblocks
      var container = document.createElement('div');
      container.appendChild(tr);
      //Need to dynamically set the width and height in the future (So the timeline adjusts size with the window size of the browser)
      //Note: I think we need to use window.InnerWidth and window.InnerHeight here but we'll come back to this at some point.
      container.style.height = "50px";
      container.style.width = "1800px";
      container.style.overflow = 'scroll';
      container.style.alignItems = 'center';
      var tr = document.createElement('tr');
      tr.appendChild(container);
      table.appendChild(tr);

      //Spacing
      var br = document.createElement('br');
      table.appendChild(br);
      //Spacing

      //Button to update Schedule
      var tr = document.createElement('tr');
      tr.appendChild(this.btnSaveToChanges);
      table.appendChild(tr);

      //Spacing
      var br = document.createElement('br');
      table.appendChild(br);
      //Spacing

      return table; //Return row which corresponds to a student's timeline
      //Append to main document
     //this.parentObject.appendChild(table);

    }


  }

  class TimeBlock {
    constructor(weekNo,studentID){

      this.weekNo = weekNo;
      this.studentID = studentID;
      this.hospitalID = 0;

      this.div = document.createElement('div');
      this.div.setAttribute("weekNo",this.weekNo);
      this.div.setAttribute("studentID", this.studentID);
      

      this.assigned = false;
      this.specialtyID = "";
      this.specialtyDuration = "";

      //Not really using right now
      this.startDate = new Date();
      this.endDate = new Date();


      this.initialiseStartDate();
      this.initialiseEndDate();
      this.initialiseDivAttributes();
    }

    initialiseDivAttributes(){
      this.div.style.width = '60px';
      this.div.style.height = '10px';
      this.div.style.padding = '10px';
      this.div.style.display = 'flex';
      this.div.style.border = "1px solid #aaaaaa";
      this.div.style.alignItems = 'center';



      var that = this;
      //On Drop Function
      this.div.ondrop = function(ev){
      ev.preventDefault();

      //Retrieve Specialty ID
      var specialtyID = ev.dataTransfer.getData("specialtyID");
      that.specialtyID = specialtyID;

      //Retrieve Specialty Duration
      var specialtyDuration = ev.dataTransfer.getData("specialtyDuration");
      that.specialtyDuration = specialtyDuration;
      //console.log("Received specialty duration: "+specialtyDuration);

      //Value that's passed
      //console.log("Sent value is: " + specialtyID);

      //Retrieve timebox div id
      var data = ev.dataTransfer.getData("text");

      //Put specialty div in timebox div
      ev.target.appendChild(document.getElementById(data));

      //Once assigned, allow for modal box to appear
      ev.target.setAttribute("data-toggle","modal"); // defining the click to bring up the modal box
      ev.target.setAttribute("data-target","#staticBackdrop"); // setting the target to the modals id
    //var hospital = prompt("please enter hospital", "vic");
    
      that.assigned = true;

      };

      //DragOver function
      this.div.ondragover = function(ev){
        ev.preventDefault();
      };

      //These are extra functions to try and fix the modal box not appearing after moving specialty div around
      //OnDragLeave function
      this.div.ondragleave = function(ev){
        //Hide Modal Box
        ev.target.setAttribute("data-toggle",""); // defining the click to bring up the modal box
        ev.target.setAttribute("data-target",""); // setting the target to the modals id
        that.assigned = false;
      };
      //OnDragEnter Function
      this.div.ondragenter = function(ev){
        //Show Modal Box
        ev.target.setAttribute("data-toggle","modal"); // defining the click to bring up the modal box
        ev.target.setAttribute("data-target","#staticBackdrop"); // setting the target to the modals id
        ev.target.setAttribute("student","studentValue");
        
      
       
        that.assigned = true;
      };

      //
      this.div.onclick = function(ev){
        if (that.assigned)
          {

            //This code runs for a TimeBlock when a SpecialtyBlock is dropped onto it
            var drop = document.getElementById('hospital_id');

            drop.setAttribute("weekNo",this.getAttribute("weekNo"));
            drop.setAttribute("studentID", this.getAttribute("studentID"));
        
            drop.setAttribute("timeBlock", this.getAttribute("timeBlock"));

            drop.setAttribute("specialtyID", ev.target.getAttribute("specialtyID"));

        }
      }

    }


    initialiseStartDate(){
      this.startDate.setMonth(0);
      this.startDate.setDate(1+(7*(this.weekNo-1)));
    }

    initialiseEndDate(){
      this.endDate = this.startDate;
      this.endDate.setDate(this.endDate.getDate()+6); //Day just before the start of the next week
    }

    getSpecialtyDuration(){
      return this.specialtyDuration;
    }

    getWeekNo(){
      return this.weekNo;
    }

    getDiv(){
      return this.div;
    }

    setSpecialtyID(specialtyID){
      this.specialtyID = specialtyID;
    }

    getSpecialtyID(){
      return this.specialtyID;
    }

    getAssigned(){
      return this.assigned;
    }

    setAssigned(value){
      this.assigned = value;
    }

   }

  class Schedule{
     constructor(){
       this.studentID = "";
       this.weekNo = "";
       this.specialtyID = "";
       this.hospitalID = "";
       this.specialtyDuration = ""
     }

     setStudentID(studentID){
       this.studentID = studentID;
     }

     setWeekNo(weekNo){
       this.weekNo = weekNo;
     }

     setSpecialtyID(specialtyID){
       this.specialtyID = specialtyID;
     }

     setHospitalID(hospitalID){
       this.hospitalID = hospitalID;
     }

     setSpecialtyDuration(specialtyDuration){
       this.specialtyDuration = specialtyDuration;
     }

     getSpecialtyDuration(){
       return this.specialtyDuration;
     }

     getWeekNo(){
       return this.weekNo;
     }

     getStudentID(){
       return this.studentID;
     }

     getSpecialtyID(){
       return this.specialtyID;
     }

     getHospitalID(){
       return this.hospitalID;
     }



    }

  class SpecialtyBlock{
      constructor(specialtyID,specialtyName,specialtyDuration,studentID){
        this.div = document.createElement('div');
        this.div.setAttribute("specialtyID", specialtyID);
        this.div.setAttribute("specialtyID",specialtyID)
        this.specialtyName = specialtyName;
        this.specialtyDuration = specialtyDuration;

        //For div ID
        this.studentID = studentID;

        this.initialiseDivAttributes();
      }

      initialiseDivAttributes(){
        //Set div attributes
        this.div.style.width = '60px';
        this.div.style.height = '10px';
        this.div.style.padding = '15px';
        this.div.style.display = 'flex';
        this.div.style.border = "1px solid #aaaaaa";
        this.div.style.alignItems = 'center';


        this.div.setAttribute("draggable","true");
        this.div.innerHTML = String(this.specialtyName);
        this.div.setAttribute("id",this.studentID+"#"+this.specialtyID);

        //On dragstart function
        var that = this;
        this.div.ondragstart = function(ev){
         // console.log("ondragstart");
          //Transfer div id
          ev.dataTransfer.setData("text", ev.target.id);
          //Transfer SpecialtyID
          //console.log("Trying to send: "+ that.specialtyID);
          //ev.dataTransfer.setData("specialtyID", that.specialtyID);

          ev.target.setAttribute("specialtyID",this.getAttribute("specialtyID"));
          
          //Transfer Specialty Duration

          ev.dataTransfer.setData("specialtyDuration", that.specialtyDuration);


        };



      }

      getSpecialtyName(){
        return this.specialtyName;
      }

      getSpecialtyDuration(){
        return this.specialtyDuration;
      }

      getDiv(){
        return this.div;
      }

     }

  class ProgrammeSchedule{
        constructor(parentObject){
          this.programmeCode = "i am the code";
          this.parentObject = parentObject;
          this.timelines =[];
          this.initialiseTimelines();
          this.populateSchedule();
        }


        //Create a number of timelines for each student in the programme
        initialiseTimelines(){

          <% @students.each do |student| %>
            this.timelines.push(new Timeline(<%=student.id%>, <%= User.find(student.user_id).id%>, <%=student.studentNumber%>));
          <%end%>
        }

        saveSchedule(){
          console.log("Trying to save schedule");
          //For each timeline
          for(var i =0; i<this.timelines.length; i++){
            console.log("Checking timline no: "+i);
            var currSchedule = this.timelines[i].getSchedules();
            console.log("Number of schedules for timeline: "+currSchedule.length);
            //For each schedule in a timeline
            for(var j =0; j<currSchedule.length;j++){
              console.log("Check schedule no: "+j);
              var studentID = currSchedule[j].getStudentID();
              var weekNo = currSchedule[j].getWeekNo();
              var specialtyID = currSchedule[j].getSpecialtyID();
              var specialtyDuration = currSchedule[j].getSpecialtyDuration();
              var hospitalID = currSchedule[j].getHospitalID();
              console.log("Schedule information is: "+studentID+" "+weekNo+" "+specialtyID+" "+specialtyDuration+" "+hospitalID);
              //TODO: Save this schedule to the Database
              //calls function to do an ajax req
              //still need to update parameters and fix Db table
              SaveRecord(studentID,specialtyID,weekNo,specialtyDuration);


            }
          }
        }

        populateSchedule(){
          var table = document.createElement('table');
          for(var i = 0; i<this.timelines.length; i++){
            var br = document.createElement('br'); //Front-end
            table.appendChild(br); //Front-end

            var tr = this.timelines[i].displayTimeline();
            table.appendChild(tr);

            table.appendChild(br); //Front-end
          }
          this.parentObject.appendChild(table);
        }

      }


  //Create a new programme schedule for a specific programme
  var programmeSchedule = new ProgrammeSchedule(document.getElementById('schedule_window'));
  var chosen_hospital_id = 0;

//onclick function to save all the schedules to the database
  function makeChanges(){
    console.log("Make changes");
    programmeSchedule.saveSchedule();
  }

  //onclick function to assign student to hospital
  function assignHospital(){
    var drop = document.getElementById('hospital_id');
    var hospitalName = drop.options[drop.selectedIndex].text;
    
    document.getElementById('showAssign').innerHTML = "Student successfully assigned to " + hospitalName + "!"; //Changing the content of the Div to display assigned student

    console.log("Hospital ID is: " +drop.options[drop.selectedIndex].value); //HospitalID

    var hospital_id = drop.options[drop.selectedIndex].value;
    chosen_hospital_id = hospital_id;
    var week_no = drop.getAttribute("weekNo");
    console.log("weekNo is: " +drop.getAttribute("weekNo"));

    var student_id = drop.getAttribute("studentID");
    console.log("studentid is: " + drop.getAttribute("studentID"));
    
    var timelines = programmeSchedule.timelines;
    var size = timelines.length;

    var timeline;
    for (let i = 0 ; i < size; i++)
    {
      timeline = timelines[i];
      if (timeline.studentID == student_id)
        {
          break;
        }
    }

    var timeblock;
    for (let i = 0 ; i < size; i++)
    {
      timeblock = timeline.timeBlocks[i];
      if (timeblock.weekNo == week_no)
        {
          break;
        }
    }

    timeblock.hospitalID = hospital_id;
    console.log("in hos assign: " + timeblock.hospitalID);


    console.log("programme code is: " +programmeSchedule.programmeCode);


    console.log("in assignHospital, specialty is: " + drop.getAttribute("specialtyID"));






  }
  //need to change the params for rotation to weekno and add specialtyduration
  function SaveRecord(studentID,specialtyID,weekNo,specialtyDuration){
    $.post("/schedules",
    {
    student_id: studentID,
    specialty_id: specialtyID,
    hospital_id: 1,
    week_no: weekNo,
    specialty_duration: specialtyDuration
    });
  }
 </script>



  <!---------------------------------------------------------------------------------------------->




</div>

<br>

<br>
<br>
</div>
